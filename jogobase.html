<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deive Abraão - Deluxe Edition</title>
    <style>
        * {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background-color: #0a0a0a;
            font-family: 'Segoe UI', Arial, sans-serif; color: white;
            overflow: hidden; touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 2 / 1;
            display: flex;
            flex-direction: column;
            background: #4682B4;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: background 0.5s ease;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: pixelated;
        }
        
        #mobileControls {
            position: absolute;
            bottom: -140px; 
            left: 0;
            width: 100%;
            height: 120px;
            pointer-events: none;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-sizing: border-box;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Ajuste para Horizontal no Mobile em Fullscreen */
        :fullscreen #game-container,
        :-webkit-full-screen #game-container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            aspect-ratio: auto;
        }

        #game-container:fullscreen #mobileControls,
        #game-container:-webkit-full-screen #mobileControls {
            bottom: 20px;
        }

        #joy-base {
            width: 100px; height: 100px;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%; pointer-events: auto;
            position: relative;
            backdrop-filter: blur(5px);
        }
        #joy-stick {
            position: absolute; top: 25px; left: 25px;
            width: 50px; height: 50px; background: #fff;
            border-radius: 50%; pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .action-btns {
            display: flex; gap: 20px; pointer-events: auto;
        }
        .btn-m {
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; background: rgba(0, 0, 0, 0.6);
            border: 3px solid #fff; color: white;
            box-shadow: 0 4px 0px rgba(255,255,255,0.2);
        }
        .btn-m:active { transform: translateY(4px); box-shadow: none; }

        .top-bar {
            position: absolute; top: 15px; right: 15px;
            display: flex; gap: 10px; z-index: 400; 
        }
        .icon-btn {
            width: 45px; height: 45px; background: rgba(0,0,0,0.6);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; border: 2px solid #fff;
            font-size: 18px; transition: 0.2s;
        }
        .icon-btn:hover { background: #fff; color: #000; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 300; text-align: center;
            backdrop-filter: blur(8px);
        }
        .hidden { display: none !important; }
        .invisible { opacity: 0; pointer-events: none; }

        .main-btn {
            background: linear-gradient(135deg, #0084ff, #00d4ff);
            color: white; border: none;
            padding: 18px 50px; font-size: 22px; border-radius: 50px;
            margin-top: 20px; cursor: pointer; font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,132,255,0.4);
            transition: 0.3s;
        }
        .main-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="top-bar">
            <div id="rotateBtn" class="icon-btn" onclick="toggleRotate()">⛶</div>
            <div id="pauseBtn" class="icon-btn hidden" onclick="togglePause()">II</div>
        </div>

        <div id="mobileControls" class="invisible">
            <div id="joy-base"><div id="joy-stick"></div></div>
            <div class="action-btns">
                <div class="btn-m" style="background: #ff4757;" id="mShoot">ATIRAR</div>
                <div class="btn-m" style="background: #0084ff;" id="mJump">PULAR</div>
            </div>
        </div>

        <div id="menuStart" class="overlay">
            <h1 style="color: #00d4ff; margin: 0; font-size: 48px; letter-spacing: 2px;">DEIVE ABRAÃO</h1>
            <p id="instructionText" style="opacity: 0.8; padding: 0 20px;"></p>
            <button class="main-btn" onclick="initGame()">INICIAR MISSÃO</button>
        </div>

        <div id="menuPause" class="overlay hidden">
            <h1>PAUSADO</h1>
            <button class="main-btn" onclick="togglePause()">RETOMAR</button>
        </div>

        <div id="screenEnd" class="overlay hidden">
            <h1 id="endMessage" style="font-size: 40px; margin-bottom: 10px;"></h1>
            <p id="finalScore" style="margin-bottom: 20px;"></p>
            <button class="main-btn" onclick="resetGame()">REPETIR MISSÃO</button>
        </div>
    </div>

    <script>
        const AudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration, vol = 0.1) {
            const osc = AudioCtx.createOscillator();
            const gain = AudioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, AudioCtx.currentTime);
            osc.connect(gain);
            gain.connect(AudioCtx.destination);
            gain.gain.setValueAtTime(vol, AudioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, AudioCtx.currentTime + duration);
            osc.start();
            osc.stop(AudioCtx.currentTime + duration);
        }

        function playBGM() {
            const osc = AudioCtx.createOscillator();
            const gain = AudioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(flightMode ? 110 : 82, AudioCtx.currentTime);
            gain.gain.value = 0.05;
            osc.connect(gain);
            gain.connect(AudioCtx.destination);
            osc.start();
            return { osc, gain };
        }
        let bgm = null;

        const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const container = document.getElementById("game-container");
        
        document.getElementById("instructionText").innerText = isMobile ? 
            "Use o joystick para mover e os botões coloridos para agir." : 
            "Use as setas para mover, Espaço para pular e Shift para atirar.";

        canvas.width = 800; canvas.height = 400;

        let gameRunning = false, paused = false, frames = 0, kills = 0, timeToSwitch = 10, flightMode = false;
        let screenShake = 0;
        const keys = { Left: false, Right: false, Up: false, Down: false };
        let projectiles = [], obstacles = [], particles = [];

        // FUNÇÃO AJUSTADA: Forçar Horizontal ao clicar no botão
        async function toggleRotate() {
            try {
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    if (container.requestFullscreen) {
                        await container.requestFullscreen();
                    } else if (container.webkitRequestFullscreen) {
                        await container.webkitRequestFullscreen();
                    }
                    // Forçar horizontal se for mobile
                    if (isMobile && screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape').catch(e => console.log("Lock negado"));
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                    if (isMobile && screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                }
            } catch (err) {
                console.log("Erro ao alternar tela cheia:", err);
            }
        }

        const deive = {
            x: 100, y: 300, w: 40, h: 90, vx: 0, vy: 0, speed: 6,
            gravity: 0.7, jumpForce: -14, grounded: false, tilt: 0,
            reset() { this.x = 100; this.y = 300; this.vx = 0; this.vy = 0; this.tilt = 0; },
            draw() {
                ctx.save();
                ctx.translate(this.x + 20, this.y + 45);
                
                let wave = 0;
                let limbSwap = 0;
                
                if(flightMode) {
                    wave = Math.sin(frames * 0.2) * 5;
                    ctx.translate(0, wave);
                } else if (Math.abs(this.vx) > 0) {
                    limbSwap = Math.sin(frames * 0.15) * 15;
                }

                if(this.vx !== 0) this.tilt = Math.max(-0.1, Math.min(0.1, this.vx * 0.02));
                ctx.rotate(this.tilt);
                ctx.translate(-20, -45);

                const skin = "#FFDBAC";
                ctx.fillStyle = skin; 
                ctx.fillRect(-8, 35 + (limbSwap * 0.2), 10, 25);
                ctx.fillRect(38, 35 - (limbSwap * 0.2), 10, 25);

                ctx.fillStyle = "#000"; ctx.fillRect(5, 0, 30, 10);
                ctx.fillStyle = skin; ctx.fillRect(5, 5, 30, 25);
                
                if (frames % 180 > 170) {
                    ctx.fillStyle = "#333";
                    ctx.fillRect(10, 14, 6, 2); ctx.fillRect(24, 14, 6, 2);
                } else {
                    ctx.fillStyle = "white"; ctx.fillRect(10, 12, 6, 6); ctx.fillRect(24, 12, 6, 6);
                    ctx.fillStyle = "black"; ctx.fillRect(12, 14, 3, 3); ctx.fillRect(26, 14, 3, 3);
                }

                ctx.fillStyle = "#0000FF"; ctx.fillRect(8, 30, 24, 30);
                ["#ff0000", "#ffff00", "#00ff00", "#ff00ff"].forEach((c, i) => { 
                    ctx.fillStyle = c; ctx.fillRect(8, 60 + (i*4), 24, 4); 
                });

                ctx.fillStyle = skin; 
                ctx.fillRect(6, 76 + (flightMode ? 5 : limbSwap), 12, 14); 
                ctx.fillRect(22, 76 + (flightMode ? 5 : -limbSwap), 12, 14); 
                
                ctx.restore();
            }
        };

        const enemy = { 
            x: 600, y: 50, w: 70, h: 35, dir: 1, hp: 100, active: true,
            reset() { this.x = 600; this.y = 50; this.hp = 100; this.active = true; },
            update() {
                if(!this.active) return;
                this.x += (4 + (kills * 0.5)) * this.dir;
                if(this.x > 700 || this.x < 100) this.dir *= -1;
                if(frames % 120 === 101) {
                    projectiles.push({x: this.x+35, y: this.y+35, vx: -7, vy: (deive.y - this.y)/40, type: 'enemy'});
                    playSound(150, 'sawtooth', 0.2, 0.05);
                }
            },
            draw() {
                if(!this.active) return;
                ctx.fillStyle = "#333"; 
                ctx.shadowBlur = 10; ctx.shadowColor = "red";
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.shadowBlur = 0;
                
                if(frames % 120 < 100) {
                    ctx.fillStyle = "white"; ctx.fillRect(this.x + 25, this.y + 10, 20, 15);
                    ctx.fillStyle = "red"; ctx.fillRect(this.x + 32, this.y + 15, 6, 6);
                }
                ctx.fillStyle = "black"; ctx.fillRect(this.x, this.y - 15, this.w, 8);
                ctx.fillStyle = "#ff4757"; ctx.fillRect(this.x, this.y - 15, (this.hp/100)*this.w, 8);
            }
        };

        function createExplosion(x, y, color) {
            for(let i=0; i<10; i++) {
                particles.push({
                    x, y, 
                    vx: (Math.random()-0.5)*10, 
                    vy: (Math.random()-0.5)*10, 
                    life: 1.0, 
                    color
                });
            }
        }

        function initGame() {
            if (AudioCtx.state === 'suspended') AudioCtx.resume();
            if(!bgm) bgm = playBGM();
            document.getElementById("menuStart").classList.add("hidden");
            document.getElementById("pauseBtn").classList.remove("hidden");
            if(isMobile) document.getElementById("mobileControls").classList.remove("invisible");
            gameRunning = true;
            loop();
        }

        function resetGame() {
            document.getElementById("screenEnd").classList.add("hidden");
            frames = 0; kills = 0; timeToSwitch = 10; flightMode = false;
            projectiles = []; obstacles = []; particles = [];
            deive.reset(); enemy.reset();
            container.style.backgroundColor = "#4682B4";
            gameRunning = true;
            if (AudioCtx.state === 'suspended') AudioCtx.resume();
            if(!bgm) bgm = playBGM();
        }

        function togglePause() {
            if(!gameRunning && !paused) return;
            paused = !paused;
            if(bgm) bgm.gain.gain.value = paused ? 0 : 0.05;
            document.getElementById("menuPause").classList.toggle("hidden", !paused);
        }

        function shoot() {
            if(!gameRunning || paused) return;
            projectiles.push({x: deive.x + 40, y: deive.y + 40, vx: 12, vy: 0, type: 'player'});
            playSound(600, 'square', 0.1, 0.08);
        }

        function loop() {
            if (gameRunning && !paused) { update(); draw(); }
            requestAnimationFrame(loop);
        }

        function update() {
            frames++;
            if (frames % 60 === 0) {
                timeToSwitch--;
                if(timeToSwitch <= 0) { 
                    flightMode = !flightMode; timeToSwitch = 10; obstacles = []; 
                    container.style.backgroundColor = flightMode ? "#1a2a6c" : "#4682B4";
                    if(bgm) bgm.osc.frequency.setTargetAtTime(flightMode ? 110 : 82, AudioCtx.currentTime, 0.5);
                }
            }

            deive.vx = 0;
            if (keys.Left) { deive.x -= deive.speed; deive.vx = -deive.speed; }
            if (keys.Right) { deive.x += deive.speed; deive.vx = deive.speed; }
            
            if (flightMode) {
                if (keys.Up) deive.y -= deive.speed;
                if (keys.Down) deive.y += deive.speed;
            } else {
                deive.vy += deive.gravity; deive.y += deive.vy;
                if (deive.y > 300) { deive.y = 300; deive.vy = 0; deive.grounded = true; }
            }

            deive.x = Math.max(0, Math.min(canvas.width - deive.w, deive.x));
            deive.y = Math.max(40, Math.min(canvas.height - deive.h, deive.y));

            enemy.update();
            if(!enemy.active && frames % 180 === 0) { enemy.active = true; enemy.hp = 100; }

            if (!flightMode && frames % 100 === 0) obstacles.push({ x: canvas.width, y: 330, w: 30, h: 70 });
            
            obstacles.forEach((obs, i) => {
                obs.x -= 6;
                if (checkCol(deive, obs)) endGameState(false);
                if (obs.x < -40) obstacles.splice(i, 1);
            });

            projectiles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy || 0;
                if(p.type === 'enemy') {
                    if(checkCol(deive, {x: p.x-5, y: p.y-5, w: 10, h: 10})) {
                        screenShake = 10;
                        endGameState(false);
                    }
                } else {
                    if(enemy.active && checkCol(enemy, {x: p.x, y: p.y, w: 20, h: 6})) {
                        enemy.hp -= 25; 
                        createExplosion(p.x, p.y, "#00ffff");
                        projectiles.splice(i, 1);
                        playSound(200, 'square', 0.1, 0.1);
                        if(enemy.hp <= 0) { 
                            enemy.active = false; kills++; 
                            createExplosion(enemy.x+35, enemy.y+17, "#ff0000");
                            playSound(100, 'sawtooth', 0.4, 0.2);
                            if(kills >= 3) endGameState(true); 
                        }
                    }
                }
                if(p.x < -20 || p.x > 820) projectiles.splice(i, 1);
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if(p.life <= 0) particles.splice(i, 1);
            });

            if(screenShake > 0) screenShake *= 0.9;
        }

        function draw() {
            ctx.save();
            if(screenShake > 1) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 390, canvas.width, 10);
            
            obstacles.forEach(obs => { 
                ctx.fillStyle = "#333"; ctx.fillRect(obs.x, obs.y, obs.w, obs.h); 
                ctx.strokeStyle = "#555"; ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
            });

            particles.forEach(p => {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
            });
            ctx.globalAlpha = 1;

            projectiles.forEach(p => {
                ctx.fillStyle = p.type === 'enemy' ? "#ff00ff" : "#00ffff";
                if(p.type === 'enemy') { ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); }
                else { ctx.fillRect(p.x, p.y, 20, 6); ctx.shadowBlur = 5; ctx.shadowColor = "#00ffff"; }
            });
            ctx.shadowBlur = 0;

            enemy.draw(); 
            deive.draw();

            ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(0,0,canvas.width, 45);
            ctx.fillStyle = "white"; ctx.font = "bold 16px 'Courier New'";
            ctx.fillText(`MISSÃO: ${flightMode ? 'AÉREA' : 'TERRESTRE'} | KILLS: ${kills}/3 | JANELA: ${timeToSwitch}s`, 20, 28);
            ctx.restore();
        }

        function checkCol(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

        function endGameState(win) {
            gameRunning = false;
            if(bgm) { bgm.osc.stop(); bgm = null; }
            const screen = document.getElementById("screenEnd");
            const msg = document.getElementById("endMessage");
            screen.classList.remove("hidden");
            msg.innerText = win ? "PARABÉNS, VOCÊ É O MELHOR!" : "NÃO FOI DESSA VEZ";
            msg.style.color = win ? "#00d4ff" : "#ff4757";
            document.getElementById("finalScore").innerText = `Kills Totais: ${kills}`;
            if(win) playSound(440, 'sine', 0.5, 0.2);
            else playSound(50, 'sawtooth', 0.8, 0.2);
        }

        window.addEventListener("keydown", (e) => {
            if(["ArrowLeft", "KeyA"].includes(e.code)) keys.Left = true;
            if(["ArrowRight", "KeyD"].includes(e.code)) keys.Right = true;
            if(["ArrowUp", "KeyW"].includes(e.code)) keys.Up = true;
            if(["ArrowDown", "KeyS"].includes(e.code)) keys.Down = true;
            if(e.code === "Space") { 
                if(gameRunning && !flightMode && deive.grounded) { 
                    deive.vy = deive.jumpForce; deive.grounded = false; 
                    playSound(300, 'sine', 0.2, 0.1);
                } 
            }
            if(e.key === "Shift") shoot();
            if(e.key === "p" || e.key === "P") togglePause();
        });
        window.addEventListener("keyup", (e) => {
            if(["ArrowLeft", "KeyA"].includes(e.code)) keys.Left = false;
            if(["ArrowRight", "KeyD"].includes(e.code)) keys.Right = false;
            if(["ArrowUp", "KeyW"].includes(e.code)) keys.Up = false;
            if(["ArrowDown", "KeyS"].includes(e.code)) keys.Down = false;
        });

        const joyBase = document.getElementById("joy-base"), joyStick = document.getElementById("joy-stick");
        let joyId = null;
        joyBase.addEventListener("touchstart", (e) => { e.preventDefault(); joyId = e.changedTouches[0].identifier; }, {passive: false});
        window.addEventListener("touchmove", (e) => {
            if(joyId === null) return;
            const t = Array.from(e.changedTouches).find(v => v.identifier === joyId);
            if(!t) return;
            const r = joyBase.getBoundingClientRect(), cx = r.left+r.width/2, cy = r.top+r.height/2;
            let dx = t.clientX-cx, dy = t.clientY-cy, d = Math.sqrt(dx*dx+dy*dy), m = 40;
            if(d > m) { dx *= m/d; dy *= m/d; }
            joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
            keys.Left = dx < -15; keys.Right = dx > 15; keys.Up = dy < -15; keys.Down = dy > 15;
        }, {passive: false});
        window.addEventListener("touchend", (e) => { 
            if(joyId !== null && Array.from(e.changedTouches).some(v => v.identifier === joyId)) {
                joyId = null; joyStick.style.transform = "translate(0,0)"; keys.Left = keys.Right = keys.Up = keys.Down = false;
            }
        });

        document.getElementById("mJump").addEventListener("touchstart", (e) => { 
            e.preventDefault(); 
            if(gameRunning && !flightMode && deive.grounded) { 
                deive.vy = deive.jumpForce; deive.grounded = false; 
                playSound(300, 'sine', 0.2, 0.1);
            } 
        });
        document.getElementById("mShoot").addEventListener("touchstart", (e) => { e.preventDefault(); shoot(); });
    </script>
</body>
</html>